<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Управление рассылкой</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    #editor-container { height: 300px; }
  </style>
</head>
<body>
  <h1>Каналы</h1>
  <ul>
    {% for cid, name in channels %}
      <li>
        {{ cid }} — {{ name or "Без имени" }}
        <form method="post" action="/delete" style="display:inline">
          <input type="hidden" name="channel_id" value="{{ cid }}">
          <button type="submit">Удалить</button>
        </form>
      </li>
    {% endfor %}
  </ul>
  <form method="post" action="/add">
    <input type="number" name="channel_id" placeholder="Channel ID" required>
    <input type="text"    name="name"       placeholder="Название (необязательно)">
    <button type="submit">Добавить канал</button>
  </form>

  <h2>Запланировать пост</h2>
  <form id="postForm" method="post" action="/schedule" enctype="multipart/form-data">
    <div id="editor-container"></div>
    <input type="hidden" name="text" id="html-text">
    <br>
    <input type="datetime-local" name="time" required><br><br>
    <input type="file" name="file" accept="image/*"><br><br>
    <button type="submit">Запланировать</button>
  </form>

  <h2>Текст в HTML (для Telethon)</h2>
  <form method="post" action="/convert">
    <textarea name="raw_text" rows="8" cols="70" placeholder="Вставь обычный текст"></textarea><br>
    <button type="submit">Сгенерировать HTML</button>
  </form>
  {% if html_result %}
    <h3>Результат:</h3>
    <textarea rows="10" cols="70" readonly>{{ html_result }}</textarea>
  {% endif %}

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // 1) Инициализация Quill
    const quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold','italic','underline'],
          ['link'],
          ['code-block'],
          [{ 'list': 'bullet' }]
        ]
      }
    });

    // 2) Подготовка HTML к отправке в Telegram
    function prepareTelegramHTML() {
      const temp = document.createElement('div');
      temp.innerHTML = quill.root.innerHTML;

      // a) li → • текст<br>
      temp.querySelectorAll('li').forEach(li => {
        const txt = li.textContent.trim();
        const frag = document.createDocumentFragment();
        frag.appendChild(document.createTextNode('• ' + txt));
        frag.appendChild(document.createElement('br'));
        li.replaceWith(frag);
      });

      // b) удаляем <ul> и <ol>, оставляя их содержимое
      temp.querySelectorAll('ul, ol').forEach(list => {
        const frag = document.createDocumentFragment();
        while(list.firstChild) frag.appendChild(list.firstChild);
        list.replaceWith(frag);
      });

      // c) чистим все теги, кроме <b>,<i>,<u>,<a>,<code>,<pre>,<br>, оставляем <p>
      const allow = ['B','I','U','A','CODE','PRE','BR','P'];
      const walker = document.createTreeWalker(temp, NodeFilter.SHOW_ELEMENT, null, false);
      const remove = [];
      while(walker.nextNode()) {
        const el = walker.currentNode;
        if(!allow.includes(el.nodeName)) remove.push(el);
        else {
          [...el.attributes].forEach(attr => {
            if(el.nodeName==='A'&&attr.name==='href') return;
            el.removeAttribute(attr.name);
          });
        }
      }
      remove.forEach(el => {
        const frag = document.createDocumentFragment();
        while(el.firstChild) frag.appendChild(el.firstChild);
        el.replaceWith(frag);
      });

      // d) <p> → двойной <br><br>
      let html = temp.innerHTML
        .replace(/<p>/g, '')
        .replace(/<\/p>/g, '<br><br>');

      // e) удаляем три и более подряд <br>
      html = html.replace(/(<br>\s*){3,}/g, '<br><br>');

      return html.trim();
    }

    // 3) Перехват отправки
    document.getElementById('postForm').addEventListener('submit', function(e) {
      e.preventDefault();
      document.getElementById('html-text').value = prepareTelegramHTML();
      this.submit();
    });
  </script>
</body>
</html>
